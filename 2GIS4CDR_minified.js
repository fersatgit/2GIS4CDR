var e,t=4294967296/Math.PI*.5,o=[],n=180/Math.PI,i=Math.PI/180,r=n/t,l=t*i;function s(e){return e>=128?e-256:e}function p(e,t,o,n,a,i,r,l,p,d){var c,h,m,g,f,u=[],y=[];for(m=0;m<o.length;m++)if((c=o[m]).symbol==n&&c.sink==a&&!c.attributes.floorId){if(h=c.vao._attributes[i],c.renderingProperties.color){let e=c.renderingProperties.color.value;u.push((e[3]<<24)+(e[2]<<16)+(e[1]<<8)+e[0])}else u.push(0);u.push(c.attributes.layerId),u.push(c.start),u.push(c.count),y.push(c.renderingProperties.widthResolved+1)}if(h){const o=h._buffer,a=o._glContext;var w=h.options.stride>>1,x=new Uint16Array(o.byteLength/Uint16Array.BYTES_PER_ELEMENT),_=new Uint32Array(u.length+4+o.byteLength/w);if(a.bindBuffer(a.ARRAY_BUFFER,o._glBuffer),a.getBufferSubData(a.ARRAY_BUFFER,0,x),_[0]=e,_[1]=p,_[2]=u.length>>2,_[3]=d,_.set(u,4),f=u.length+4,"line"==n){let e=0;for(m=0;m<y.length;m++){let t=(u[e+2]+u[e+3])*w,o=y[m]/p*16384;for(g=u[e+2]*w;g<t;g+=w)_[f]=4*x[g]+r+s(255&x[g+2])*o,_[f+1]=4*x[g+1]+l+s(x[g+2]>>8)*o,f+=2;e+=4}}else for(m=0;m<x.length;m+=w)_[f]=4*x[m]+r,_[f+1]=4*x[m+1]+l,f+=2;t.send(_)}}async function d(){new TextEncoder;var a,s,d,c,h,m,g,f,u,y,w,x,_,b,M,v,F,k,P,E=new XMLHttpRequest,A=0;for(document.getElementById("spinner").style.visibility="visible",m=g=1/0,f=u=-1/0,x=0;x<o.length;x++){const e=o[x];e.Selected&&(m=Math.min(m,e.x),g=Math.min(g,e.y),f=Math.max(f,e.x+131072),u=Math.max(u,e.y+131072),A+=10/1024)}P=0;do{h=!1;let R=Math.max(f-m,u-g);for(x=0;x<o.length;x++){let f=o[x];if(f.Selected){h=!0,map.setCenter([(f.x+65536)*r,Math.atan(Math.sinh((f.y+65536)/t))*n],{animate:!1}),map.setZoom(20,{animate:!1}),await new Promise(e=>setTimeout(e,1000));const o=map._impl.modules.tileManager.objects,u=f.x-m-65536,x=f.y-g-65536;for(_=0;_<o.length;_++){let h=o[_];if("zenith"==h.purpose&&131072*h.coords[0]-2147483648==f.x&&131072*h.coords[1]-2147483648==f.y&&15==h.coords[2]){P++,await p(0,e,h.children,"polygon","fill","a_vec2_vertex",u,x,R,P/A),P++;let S=o[_+1];for(S&&"zenith"==S.purpose&&131072*S.coords[0]-2147483648==f.x&&131072*S.coords[1]-2147483648==f.y&&15==S.coords[2]&&await p(1,e,S.children,"line","solid","a_vec2_vertex",u,x,R,P/A),P++,await p(1,e,h.children,"line","solid","a_vec2_vertex",u,x,R,P/A),P++,await p(2,e,h.children,"polygonExtrusion","topFill","a_vec4_vertex",u,x,R,P/A),P+=6,a=1,s=[],d="",c=0;;){E.open("GET","https://catalog.api.2gis.com/3.0/items/geocode?type=building,street&locale=ru_RU&page_size=50&page="+a+"&fields=items.address,items.point&point1="+f.x*r+","+Math.atan(Math.sinh((f.y+131072)/t))*n+"&point2="+(f.x+131072)*r+","+Math.atan(Math.sinh(f.y/t))*n+"&key=demo",!1),E.send(null);var C=E.responseText;if(!C.includes("result"))break;for(C=JSON.parse(C).result.items,b=0;b<C.length;b++)k=C[b].address&&C[b].address.components&&C[b].address.components[0].number?C[b].address.components[0].number:C[b].name,d=d.concat(k),s.push(C[b].point.lon*l-m,Math.asinh(Math.tan(C[b].point.lat*i))*t-g,k.length),c++;a++}if(c){for(y=new Uint32Array(3*c+4+(d.length+1)/2),w=new Uint16Array(y.buffer,8*c+16),y[0]=3,y[1]=R,y[2]=c,y[3]=P/A,M=F=0,b=0;b<c;b++)for(y[2*b+4]=s[3*b],y[2*b+5]=s[3*b+1],w[M]=s[3*b+2],M+=2,v=0;v<s[3*b+2];v++)w[M]=d.charCodeAt(F),F++,M++;e.send(y)}f.Selected=!1,console.log(h);break}}}}}while(h);for(;e.bufferedAmount>0;)await new Promise(e=>setTimeout(e,500));window.close()}function c(e){let t=map._impl.modules.camera.flat.unproject(e.point);t[0]=131072*Math.floor(t[0]/131072),t[1]=131072*Math.floor(t[1]/131072);const n=o.find(e=>e.x==t[0]&&e.y==t[1]);let a;a=(n.Selected=!n.Selected)?new mapgl.Polygon(map,{coordinates:n.polygon._impl.options.coordinates,color:"#00009950",strokeWidth:0}):new mapgl.Polygon(map,{coordinates:n.polygon._impl.options.coordinates,color:"#FFFFFF00",strokeWidth:3,strokeColor:"#bb0000"}),n.polygon.destroy(),a.on("click",c),n.polygon=a}function h(){for(var e=map._impl.modules.camera.getViewportVertices(),a=131072*Math.floor(e[0][0]/131072),i=131072*Math.floor(e[0][1]/131072),l=0;l<o.length;)o[l].Selected||(o[l].polygon.destroy(),o[l]=o[o.length-1],o.length--,l--),l++;if(map.getZoom()>13)do{x=a;do{if(!o.find(e=>e.x==x&&e.y==i)){const e=x*r,a=Math.atan(Math.sinh(i/t))*n,l=(x+131072)*r,s=Math.atan(Math.sinh((i+131072)/t))*n;o.push({polygon:new mapgl.Polygon(map,{coordinates:[[[e,a],[l,a],[l,s],[e,s],[e,a]]],color:"#FFFFFF00",strokeWidth:3,strokeColor:"#bb0000"}),x:x,y:i,Selected:!1}),o[o.length-1].polygon.on("click",c)}x+=131072}while(x<e[2][0]);i+=131072}while(i<e[2][1])}map=new mapgl.Map("container",{zoom:2,zoomControl:!1,key:JakartaVectorTilesKey}),map._impl.configureFloors({activeGroup:"metro",allowedFloorIds:[]}),map._impl.events.zoomend=[h],map._impl.events.moveend=[h],map._impl.state.disablePitchByUserInteraction=!0,map._impl.state.disableRotationByUserInteraction=!0,window.onunload=function(){e.close()},(e=new WebSocket("ws://127.0.0.1:"+Port)).onerror=function(e){alert("Нет связи с CorelDraw"),window.close()},addEventListener("resize",(function(){const e=map._impl.getCanvas(),t=e.style,{innerWidth:o,innerHeight:n}=window;e.width=o,e.height=n,t.width=o,t.height=n,map._impl.setViewport(o,n)})),h();new mapgl.Control(map,'<button onClick="disabled=true;d()">Экспорт в CorelDraw</button>',{position:"topLeft"})