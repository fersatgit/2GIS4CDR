var e,t=4294967296/Math.PI*.5,o=[],n=180/Math.PI,a=Math.PI/180,i=n/t,r=t*a;function l(e){return e>=128?e-256:e}function s(e,t,o,n,a,i,r,s,p,c){var d,h,m,f,g,u=[],y=[];for(m=0;m<o.length;m++)if((d=o[m]).symbol==n&&d.sink==a&&!d.attributes.floorId){if(h=d.vao._attributes[i],d.renderingProperties.color){let e=d.renderingProperties.color.value;u.push((e[3]<<24)+(e[2]<<16)+(e[1]<<8)+e[0])}else u.push(0);u.push(d.attributes.layerId),u.push(d.start),u.push(d.count),y.push(d.renderingProperties.widthResolved+1)}if(h){const o=h._buffer,a=o._glContext;var w=h.options.stride>>1,_=new Uint16Array(o.byteLength/Uint16Array.BYTES_PER_ELEMENT),x=new Uint32Array(u.length+4+o.byteLength/w);if(a.bindBuffer(a.ARRAY_BUFFER,o._glBuffer),a.getBufferSubData(a.ARRAY_BUFFER,0,_),x[0]=e,x[1]=p,x[2]=u.length>>2,x[3]=c,x.set(u,4),g=u.length+4,"line"==n){let e=0;for(m=0;m<y.length;m++){let t=(u[e+2]+u[e+3])*w,o=y[m]/p*16384;for(f=u[e+2]*w;f<t;f+=w)x[g]=4*_[f]+r+l(255&_[f+2])*o,x[g+1]=4*_[f+1]+s+l(_[f+2]>>8)*o,g+=2;e+=4}}else for(m=0;m<_.length;m+=w)x[g]=4*_[m]+r,x[g+1]=4*_[m+1]+s,g+=2;t.send(x)}}async function p(){new TextEncoder;var l,p,c,d,h,m,f,g,u,y,w,_,x,M,b,v,F,k,E,P=new XMLHttpRequest,S=0;for(document.getElementById("spinner").style.visibility="visible",m=f=1/0,g=u=-1/0,_=0;_<o.length;_++){const e=o[_];e.Selected&&(m=Math.min(m,e.x),f=Math.min(f,e.y),g=Math.max(g,e.x+131072),u=Math.max(u,e.y+131072),S+=10/1024)}E=0;do{h=!1;let R=Math.max(g-m,u-f);for(_=0;_<o.length;_++){let g=o[_];if(g.Selected){h=!0,map.setCenter([(g.x+65536)*i,Math.atan(Math.sinh((g.y+65536)/t))*n],{animate:!1}),map.setZoom(20,{animate:!1}),await map._defaultSource._impl.zenithSource.fetchTile([Math.floor((g.x+2147483648)/131072),Math.floor((g.y+2147483648)/131072),15,16],map._impl.state);const o=map._impl.modules.tileManager.objects,u=g.x-m-65536,_=g.y-f-65536;for(x=0;x<o.length;x++){let h=o[x];if("zenith"==h.purpose&&131072*h.coords[0]-2147483648==g.x&&131072*h.coords[1]-2147483648==g.y&&15==h.coords[2]){E++,await s(0,e,h.children,"polygon","fill","a_vec2_vertex",u,_,R,E/S),E++;let C=o[x+1];for(C&&"zenith"==C.purpose&&131072*C.coords[0]-2147483648==g.x&&131072*C.coords[1]-2147483648==g.y&&15==C.coords[2]&&await s(1,e,C.children,"line","solid","a_vec2_vertex",u,_,R,E/S),E++,await s(1,e,h.children,"line","solid","a_vec2_vertex",u,_,R,E/S),E++,await s(2,e,h.children,"polygonExtrusion","topFill","a_vec4_vertex",u,_,R,E/S),E+=6,l=1,p=[],c="",d=0;;){P.open("GET","https://catalog.api.2gis.com/3.0/items/geocode?type=building,street&locale=ru_RU&page_size=50&page="+l+"&fields=items.address,items.point&point1="+g.x*i+","+Math.atan(Math.sinh((g.y+131072)/t))*n+"&point2="+(g.x+131072)*i+","+Math.atan(Math.sinh(g.y/t))*n+"&key=demo",!1),P.send(null);var A=P.responseText;if(!A.includes("result"))break;for(A=JSON.parse(A).result.items,M=0;M<A.length;M++)k=A[M].address&&A[M].address.components&&A[M].address.components[0].number?A[M].address.components[0].number:A[M].name,c=c.concat(k),p.push(A[M].point.lon*r-m,Math.asinh(Math.tan(A[M].point.lat*a))*t-f,k.length),d++;l++}if(d){for(y=new Uint32Array(3*d+4+(c.length+1)/2),w=new Uint16Array(y.buffer,8*d+16),y[0]=3,y[1]=R,y[2]=d,y[3]=E/S,b=F=0,M=0;M<d;M++)for(y[2*M+4]=p[3*M],y[2*M+5]=p[3*M+1],w[b]=p[3*M+2],b+=2,v=0;v<p[3*M+2];v++)w[b]=c.charCodeAt(F),F++,b++;e.send(y)}g.Selected=!1,console.log(h);break}}}}}while(h);for(;e.bufferedAmount>0;)await new Promise(e=>setTimeout(e,500));window.close()}function c(e){let t=map._impl.modules.camera.flat.unproject(e.point);t[0]=131072*Math.floor(t[0]/131072),t[1]=131072*Math.floor(t[1]/131072);const n=o.find(e=>e.x==t[0]&&e.y==t[1]);let a;a=(n.Selected=!n.Selected)?new mapgl.Polygon(map,{coordinates:n.polygon._impl.options.coordinates,color:"#00009950",strokeWidth:0}):new mapgl.Polygon(map,{coordinates:n.polygon._impl.options.coordinates,color:"#FFFFFF00",strokeWidth:3,strokeColor:"#bb0000"}),n.polygon.destroy(),a.on("click",c),n.polygon=a}function d(){for(var e=map._impl.modules.camera.getViewportVertices(),a=131072*Math.floor(e[0][0]/131072),r=131072*Math.floor(e[0][1]/131072),l=0;l<o.length;)o[l].Selected||(o[l].polygon.destroy(),o[l]=o[o.length-1],o.length--,l--),l++;if(map.getZoom()>13)do{x=a;do{if(!o.find(e=>e.x==x&&e.y==r)){const e=x*i,a=Math.atan(Math.sinh(r/t))*n,l=(x+131072)*i,s=Math.atan(Math.sinh((r+131072)/t))*n;o.push({polygon:new mapgl.Polygon(map,{coordinates:[[[e,a],[l,a],[l,s],[e,s],[e,a]]],color:"#FFFFFF00",strokeWidth:3,strokeColor:"#bb0000"}),x:x,y:r,Selected:!1}),o[o.length-1].polygon.on("click",c)}x+=131072}while(x<e[2][0]);r+=131072}while(r<e[2][1])}map=new mapgl.Map("container",{zoom:2,zoomControl:false,key:JakartaVectorTilesKey}),map._impl.configureFloors({activeGroup:"metro",allowedFloorIds:[]}),map._impl.events.zoomend=[d],map._impl.events.moveend=[d],map._impl.state.disablePitchByUserInteraction=!0,map._impl.state.disableRotationByUserInteraction=!0,window.onunload=function(){e.close()},(e=new WebSocket("ws://127.0.0.1:"+Port)).onerror=function(e){alert("Нет связи с CorelDraw"),window.close()},addEventListener("resize",(function(){const e=map._impl.getCanvas(),t=e.style,{innerWidth:o,innerHeight:n}=window;e.width=o,e.height=n,t.width=o,t.height=n,map._impl.setViewport(o,n)})),d();new mapgl.Control(map,'<button onClick="disabled=true;p()">Экспорт в CorelDraw</button>',{position:"topLeft"})